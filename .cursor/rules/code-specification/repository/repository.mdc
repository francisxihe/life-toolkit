---
description: Repository æ¨¡å¼ä»£ç ç”Ÿæˆè§„èŒƒæ€»è§ˆ
alwaysApply: false
---

# Repository è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

Repository æ¨¡å¼æ˜¯æ•°æ®è®¿é—®å±‚çš„æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼ŒLife Toolkit é¡¹ç›®é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼š

- **Business Layer** (`packages/business/server/`): å®šä¹‰ Repository Interface
- **Server Layer** (`apps/server/`): å®ç° Repository Interfaceï¼Œå¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘
- **Desktop Layer** (`apps/desktop/`): å®ç° Repository Interfaceï¼Œé€‚é…æ¡Œé¢ç«¯æ•°æ®è®¿é—®

## ğŸ—ï¸ æ¶æ„æ¨¡å¼

### ä¸‰å±‚ Repository æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Business Layer            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        Interface å®šä¹‰          â”‚ â”‚
â”‚  â”‚  - æ•°æ®è®¿é—®å¥‘çº¦è§„èŒƒ            â”‚ â”‚
â”‚  â”‚  - DTO/VO ç±»å‹çº¦æŸ             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Server Layer              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      TypeORM å®ç°               â”‚ â”‚
â”‚  â”‚  - å¤æ‚æŸ¥è¯¢æ„å»º                 â”‚ â”‚
â”‚  â”‚  - å…³è”å…³ç³»å¤„ç†                 â”‚ â”‚
â”‚  â”‚  - äº‹åŠ¡ç®¡ç†                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚  (æ•°æ®åŒæ­¥)
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Desktop Layer              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      SQLite å®ç°                â”‚ â”‚
â”‚  â”‚  - æœ¬åœ°æ•°æ®å­˜å‚¨                 â”‚ â”‚
â”‚  â”‚  - ç¦»çº¿æ•°æ®åŒæ­¥                 â”‚ â”‚
â”‚  â”‚  - è½»é‡çº§æŸ¥è¯¢ä¼˜åŒ–               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»“æ„è§„èŒƒ

### Business Layer Module Repository Interface
```
packages/business/server/src/{module}/
â””â”€â”€ {module}.repository.ts     # Repository Interface å®šä¹‰
```

### Server Layer Module Repository Implementation
```
apps/server/src/business/{module}/
â””â”€â”€ {module}.repository.ts     # TypeORM Repository å®ç°
```

### Desktop Layer Module Repository Implementation
```
apps/desktop/src/database/{module}/
â””â”€â”€ {module}.repository.ts     # SQLite Repository å®ç°
```

## è®¾è®¡åŸåˆ™

### 1. Interface ä¼˜å…ˆåŸåˆ™
- **Business Layer** è´Ÿè´£å®šä¹‰æ•°æ®è®¿é—®å¥‘çº¦
- **Server/Desktop Layer** è´Ÿè´£å®ç°å…·ä½“æ•°æ®è®¿é—®é€»è¾‘
- ç¡®ä¿è·¨å¹³å°æ•°æ®è®¿é—®çš„ä¸€è‡´æ€§

### 2. å¹³å°é€‚é…åŸåˆ™
- **Server**: æ”¯æŒå¤æ‚æŸ¥è¯¢ã€å…³è”å…³ç³»ã€äº‹åŠ¡ç®¡ç†
- **Desktop**: æ”¯æŒç¦»çº¿è®¿é—®ã€è½»é‡çº§æŸ¥è¯¢ã€æœ¬åœ°å­˜å‚¨ä¼˜åŒ–

### 3. æ•°æ®ä¸€è‡´æ€§åŸåˆ™
- ç»Ÿä¸€çš„ DTO/VO ç±»å‹å®šä¹‰
- è·¨å¹³å°çš„æ•°æ®æ˜ å°„é€»è¾‘
- ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§ä¿è¯

## æ•°æ®æµå‘

### åˆ›å»ºæ“ä½œ
```mermaid
graph TD
    A[Client Requests] --> B[Controller]
    B --> C[Service]
    C --> D[Repository Interface]
    D --> E[Server Module Repository]
    D --> F[Desktop Repository]
    E --> G[(MySQL)]
    F --> H[(SQLite)]
```

### æŸ¥è¯¢æ“ä½œ
```mermaid
graph TD
    A[Client Requests] --> B[Controller]
    B --> C[Service]
    C --> D[Repository Interface]
    D --> E[Server Module Repository]
    D --> F[Desktop Repository]
    E --> G[(MySQL)]
    F --> H[(SQLite)]
    G --> I[DTO Mapping]
    H --> I
    I --> J[Return Data]
```

## æ ¸å¿ƒæ¥å£è§„èŒƒ

### åŸºç¡€ CRUD æ¥å£
```typescript
export interface BaseRepository<TDto, TCreateModuleDto, TUpdateModuleDto, TFilterDto> {
  // åˆ›å»º
  create(createDto: TCreateModuleDto): Promise<TDto>;
  createWithExtras(createDto: TCreateModuleDto, extras: Partial<any>): Promise<TDto>;

  // æŸ¥è¯¢
  findAll(filterModuleListFilterDto): Promise<TDto[]>;
  page(filterModuleListFilterDto & PageFilter): Promise<PageModuleDto>>;
  findById(id: string, relations?: string[]): Promise<TDto>;
  findOneBy(condition: any): Promise<TDto | null>;

  // æ›´æ–°
  update(id: string, updateDto: TUpdateModuleDto): Promise<TDto>;
  batchUpdate(includeIds: string[], updateDto: TUpdateModuleDto): Promise<TDto[]>;

  // åˆ é™¤
  delete(id: string): Promise<boolean>;
  deleteByFilter(filterModuleListFilterDto): Promise<void>;
  softDelete(id: string): Promise<void>;
  batchSoftDelete(includeIds: string[]): Promise<void>;
}
```

### åˆ†é¡µæŸ¥è¯¢æ¥å£
```typescript
export interface PageResult<T> {
  list: T[];
  total: number;
  pageNum: number;
  pageSize: number;
}

export interface PageFilter {
  pageNum?: number;
  pageSize?: number;
  orderBy?: string;
  sortOrder?: 'ASC' | 'DESC';
}
```

## å®ç°ç­–ç•¥

### Server Layer å®ç°ç­–ç•¥
- ä½¿ç”¨ TypeORM Repository æ¨¡å¼
- æ”¯æŒå¤æ‚æŸ¥è¯¢æ„å»ºå™¨
- å¤„ç†å®ä½“å…³è”å…³ç³»
- å®ç°äº‹åŠ¡ç®¡ç†
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

### Desktop Layer å®ç°ç­–ç•¥
- ä½¿ç”¨ TypeORM Repository é€‚é… SQLite
- å®ç°æœ¬åœ°æ•°æ®ç¼“å­˜
- æ”¯æŒç¦»çº¿æ•°æ®æ“ä½œ
- ä¼˜åŒ–è½»é‡çº§æŸ¥è¯¢
- å¤„ç†æ•°æ®åŒæ­¥é€»è¾‘

### Business Layer å®ç°ç­–ç•¥
- å®šä¹‰æ¸…æ™°çš„æ•°æ®è®¿é—®å¥‘çº¦
- ç»Ÿä¸€ DTO/VO ç±»å‹è§„èŒƒ
- æä¾›è·¨å¹³å°å…¼å®¹çš„æ¥å£
- ç¡®ä¿ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§

## æ•°æ®æ˜ å°„è§„èŒƒ

### Entity â†’ DTO æ˜ å°„
```typescript
// ä½¿ç”¨ DTO å†…ç½®æ–¹æ³•è¿›è¡Œæ˜ å°„
class ModuleDto {
  // å®ä¾‹æ–¹æ³•ï¼šä»å®ä½“å¯¼å…¥æ•°æ®
  importEntity(entity: Module): ModuleDto {
    this.id = entity.id;
    this.name = entity.name;
    // ... å…¶ä»–å­—æ®µæ˜ å°„
    this.createdAt = entity.createdAt;
    this.updatedAt = entity.updatedAt;
    return this;
  }

  // é™æ€æ–¹æ³•ï¼šåˆ›å»ºæ–°å®ä¾‹å¹¶å¯¼å…¥æ•°æ®
  static importEntity(entity: Module): ModuleDto {
    return new ModuleDto().importEntity(entity);
  }

  // å¯¼å‡ºä¸º VO
  exportVo(): ModuleVo {
    return {
      id: this.id,
      name: this.name,
      // ... å…¶ä»–å­—æ®µæ˜ å°„
    };
  }
}
```

## æŸ¥è¯¢æ„å»ºè§„èŒƒ

### åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
```typescript
// æ”¯æŒçµæ´»çš„æŸ¥è¯¢æ¡ä»¶æ„å»º
private buildWhere(filter: FilterDto): FindOptionsWhere<Entity> {
  const where: FindOptionsWhere<Entity> = {};

  // å­—ç¬¦ä¸²æ¡ä»¶
  if (filter.keyword) {
    where.name = Like(`%${filter.keyword}%`);
  }

  // æ—¥æœŸèŒƒå›´æ¡ä»¶
  if (filter.startDate && filter.endDate) {
    where.createdAt = Between(filter.startDate, filter.endDate);
  }

  // æšä¸¾æ¡ä»¶
  if (filter.status) {
    where.status = filter.status;
  }

  return where;
}
```

## æ€§èƒ½ä¼˜åŒ–
## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥
- å¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- å¤åˆç´¢å¼•ä¼˜åŒ–å¤šæ¡ä»¶æŸ¥è¯¢
- å”¯ä¸€ç´¢å¼•ä¿è¯æ•°æ®çº¦æŸ

### æŸ¥è¯¢ä¼˜åŒ–
- é¿å… N+1 æŸ¥è¯¢é—®é¢˜
- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢é™åˆ¶æ•°æ®é‡
- é€‰æ‹©æ€§åŠ è½½å…³è”æ•°æ®
- ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®

## âœ… è´¨é‡ä¿è¯

### ä»£ç è§„èŒƒæ£€æŸ¥
- [ ] Repository Interface å®šä¹‰å®Œæ•´
- [ ] CRUD æ–¹æ³•å®ç°é½å…¨
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- [ ] ç±»å‹å®šä¹‰å‡†ç¡®æ— è¯¯
- [ ] å‘½åè§„èŒƒç»Ÿä¸€

### æ€§èƒ½æ£€æŸ¥
- [ ] æŸ¥è¯¢è¯­å¥ä¼˜åŒ–
- [ ] ç´¢å¼•ä½¿ç”¨åˆç†
- [ ] å…³è”æŸ¥è¯¢ä¼˜åŒ–
- [ ] åˆ†é¡µæŸ¥è¯¢å®ç°

### ä¸€è‡´æ€§æ£€æŸ¥
- [ ] è·¨å¹³å°æ¥å£ä¸€è‡´
- [ ] æ•°æ®æ˜ å°„æ­£ç¡®
- [ ] ä¸šåŠ¡è§„åˆ™ç»Ÿä¸€
- [ ] é”™è¯¯å¤„ç†ç»Ÿä¸€

## ğŸ“ ç›¸å…³è§„èŒƒ

- [Entity è§„èŒƒ](./entity.mdc) - æ•°æ®å®ä½“å®šä¹‰è§„èŒƒ
- [Service è§„èŒƒ](./service.mdc) - ä¸šåŠ¡æœåŠ¡å±‚è§„èŒƒ
- [DTO è§„èŒƒ](./dto.mdc) - æ•°æ®ä¼ è¾“å¯¹è±¡è§„èŒƒ
- [Controller è§„èŒƒ](./controller.mdc) - æ§åˆ¶å™¨å±‚è§„èŒƒ
