---
description: ç¼–å†™server Entityä»£ç æ—¶
alwaysApply: false
---
# Entity è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬è§„èŒƒå®šä¹‰äº† Life Toolkit é¡¹ç›®ä¸­ TypeORM Entity çš„æ ‡å‡†ç»“æ„ã€è£…é¥°å™¨ä½¿ç”¨ã€éªŒè¯çº¦æŸç­‰è§„èŒƒï¼Œç¡®ä¿æ•°æ®æ¨¡å‹çš„ä¸€è‡´æ€§ã€ç±»å‹å®‰å…¨å’Œæ•°æ®å®Œæ•´æ€§ã€‚

## ğŸ—ï¸ åŸºç¡€æ¶æ„

### ç»§æ‰¿ç»“æ„
```typescript
// æ‰€æœ‰ä¸šåŠ¡ Entity å¿…é¡»ç»§æ‰¿ BaseEntity
import { BaseEntity } from "@/base/base.entity";

@Entity("table_name")
export class BusinessEntity extends BaseEntity {
  // ä¸šåŠ¡å­—æ®µå®šä¹‰
}
```

### æ¨¡å‹åˆ†ç¦»æ¨¡å¼ (æ¨è)
```typescript
// å¯¹äºå¤æ‚ Entityï¼Œå»ºè®®ä½¿ç”¨æ¨¡å‹åˆ†ç¦»æ¨¡å¼
export class BusinessModel extends BaseEntity {
  // åŸºç¡€ä¸šåŠ¡å­—æ®µå®šä¹‰
}

@Entity("business_table")
export class Business extends BusinessModel {
  // å…³è”å…³ç³»å’Œç‰¹æ®Šå­—æ®µå®šä¹‰
}
```

### BaseEntity æä¾›çš„åŸºç¡€å­—æ®µ
```typescript
export class BaseEntity {
  @PrimaryGeneratedColumn("uuid")
  id: string;                    // ä¸»é”® (UUID)

  @CreateDateColumn()
  createdAt: Date;              // åˆ›å»ºæ—¶é—´

  @UpdateDateColumn()
  updatedAt: Date;              // æ›´æ–°æ—¶é—´

  @DeleteDateColumn({ nullable: true })
  deletedAt?: Date;             // è½¯åˆ é™¤æ—¶é—´
}
```

## ğŸ¯ Entity å®šä¹‰è§„èŒƒ

### 1. æ–‡ä»¶å‘½åçº¦å®š
- **Entity æ–‡ä»¶**: `{module}.entity.ts`
- **æšä¸¾æ–‡ä»¶**: `{module}.enum.ts` æˆ–åœ¨ entity æ–‡ä»¶ä¸­å®šä¹‰
- **ç´¢å¼•æ–‡ä»¶**: `index.ts`

### 2. å¯¼å…¥é¡ºåº
```typescript
// 1. åŸºç¡€ç±»
import { BaseEntity } from "../../base/base.entity";

// 2. æšä¸¾å’Œç±»å‹
import { ModuleStatus, ModuleType } from "@life-toolkit/enum";

// 3. å…³è”å®ä½“
import { RelatedEntity } from "../related";

// 4. TypeORM è£…é¥°å™¨
import { Entity, Column, ManyToOne, JoinColumn } from "typeorm";

// 5. éªŒè¯è£…é¥°å™¨
import {
  IsString,
  IsOptional,
  IsEnum,
  IsArray,
  IsNumber,
  IsISO8601,
} from "class-validator";

// 6. è½¬æ¢è£…é¥°å™¨
import { Type } from "class-transformer";
```

### 3. Entity è£…é¥°å™¨è§„èŒƒ
```typescript
// æ ‡å‡†æ ¼å¼ï¼šè¡¨åä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
@Entity("module_name")
export class ModuleName extends BaseEntity {
  // å­—æ®µå®šä¹‰
}

// æ ‘å½¢ç»“æ„å®ä½“
@Entity("tree_module")
@Tree("closure-table")
export class TreeModule extends BaseEntity {
  // å­—æ®µå®šä¹‰
}

// å¤åˆç´¢å¼•å®šä¹‰
@Entity("indexed_module")
@Index(["field1", "field2"], { unique: true })
export class IndexedModule extends BaseEntity {
  // å­—æ®µå®šä¹‰
}
```

## ğŸ“ å­—æ®µå®šä¹‰è§„èŒƒ

### 1. å­—æ®µå®šä¹‰æ¨¡æ¿
```typescript
/** å­—æ®µæè¿° */
@Column(columnOptions)
@ValidationDecorator()
@TransformDecorator()
fieldName: FieldType;
```

### 2. å­—æ®µç±»å‹æ˜ å°„è¡¨
```typescript
const FIELD_TYPE_MAPPING = {
  // åŸºç¡€ç±»å‹
  string: {
    column: "@Column('varchar')",
    validator: "@IsString()",
    transform: null,
    tsType: "string"
  },
  text: {
    column: "@Column('text', { nullable: true })",
    validator: "@IsString() @IsOptional()",
    transform: null,
    tsType: "string"
  },
  number: {
    column: "@Column('int', { nullable: true })",
    validator: "@IsNumber() @IsOptional()",
    transform: "@Type(() => Number)",
    tsType: "number"
  },
  decimal: {
    column: "@Column('decimal', { precision: 10, scale: 2, nullable: true })",
    validator: "@IsNumber() @IsOptional()",
    transform: "@Type(() => Number)",
    tsType: "number"
  },
  boolean: {
    column: "@Column('boolean', { nullable: true })",
    validator: "@IsBoolean() @IsOptional()",
    transform: "@Type(() => Boolean)",
    tsType: "boolean"
  },
  date: {
    column: "@Column('date')",
    validator: "@IsISO8601()",
    transform: null,
    tsType: "Date"
  },
  datetime: {
    column: "@Column('datetime', { nullable: true })",
    validator: "@IsOptional()",
    transform: null,
    tsType: "Date"
  },
  time: {
    column: "@Column('time', { nullable: true })",
    validator: null,
    transform: null,
    tsType: "string"
  },
  enum: {
    column: "@Column({ type: 'varchar', length: 20, nullable: true })",
    validator: "@IsEnum(EnumType) @IsOptional()",
    transform: null,
    tsType: "EnumType"
  },
  array: {
    column: "@Column('simple-array')",
    validator: "@IsArray() @IsString({ each: true })",
    transform: null,
    tsType: "string[]"
  },
  json: {
    column: "@Column('json', { nullable: true })",
    validator: "@IsOptional()",
    transform: null,
    tsType: "any"
  }
};
```

### 3. æ ‡å‡†å­—æ®µç¤ºä¾‹

#### å­—ç¬¦ä¸²å­—æ®µ
```typescript
/** æ ‡é¢˜ - å¿…å¡«å­—ç¬¦ä¸² */
@Column("varchar")
@IsString()
title!: string;

/** æè¿° - å¯é€‰å­—ç¬¦ä¸² */
@Column("text", { nullable: true })
@IsString()
@IsOptional()
description?: string;

/** å”¯ä¸€æ ‡è¯†ç¬¦ */
@Column({ unique: true })
@IsString()
code: string;
```

#### æ•°å­—å­—æ®µ
```typescript
/** é‡è¦ç¨‹åº¦ */
@Column("int", { nullable: true })
@IsNumber()
@IsOptional()
@Type(() => Number)
importance?: number;

/** ç´§æ€¥ç¨‹åº¦ */
@Column("int", { nullable: true })
@IsNumber()
@IsOptional()
@Type(() => Number)
urgency?: number;
```

#### å¸ƒå°”å­—æ®µ
```typescript
/** æ¿€æ´»çŠ¶æ€ */
@Column({ default: false })
@IsBoolean()
@Type(() => Boolean)
isActive: boolean = false;

/** æ˜¯å¦å®Œæˆ */
@Column({ default: false })
@IsBoolean()
@Type(() => Boolean)
isCompleted: boolean = false;
```

#### æšä¸¾å­—æ®µ
```typescript
/** çŠ¶æ€ - å¿…å¡« */
@Column({
  type: "varchar",
  length: 20,
  nullable: true,
})
@IsEnum(ModuleStatus)
status!: ModuleStatus;

/** æ¥æº - å¯é€‰ */
@Column({
  type: "varchar",
  length: 20,
  nullable: true,
})
@IsOptional()
source?: ModuleType;
```

#### æ—¥æœŸæ—¶é—´å­—æ®µ
```typescript
/** è®¡åˆ’æ—¥æœŸ */
@Column("date")
@IsISO8601()
planDate: Date = new Date();

/** å®Œæˆæ—¶é—´ - å¯é€‰ */
@Column("datetime", {
  nullable: true,
})
doneAt?: Date;

/** æ”¾å¼ƒæ—¶é—´ - å¯é€‰ */
@Column("datetime", {
  nullable: true,
})
abandonedAt?: Date;

/** è®¡åˆ’å¼€å§‹æ—¶é—´ - å¯é€‰ */
@Column("time", { nullable: true })
planStartAt?: string;

/** è®¡åˆ’ç»“æŸæ—¶é—´ - å¯é€‰ */
@Column("time", { nullable: true })
planEndAt?: string;
```

#### æ•°ç»„å­—æ®µ
```typescript
/** æ ‡ç­¾æ•°ç»„ */
@Column("simple-array", { nullable: true })
@IsArray()
@IsString({ each: true })
@IsOptional()
tags?: string[] = [];

/** JSON æ•°ç»„ */
@Column("json", { nullable: true })
@IsArray()
@IsOptional()
metadata?: any[];
```

#### ç‰¹æ®Šå­—æ®µ
```typescript
/** é‚®ç®±å­—æ®µ */
@Column({ unique: true })
@IsEmail()
@IsString()
email: string;

/** URL å­—æ®µ */
@Column({ nullable: true })
@IsUrl()
@IsString()
@IsOptional()
website?: string;

/** JSON å¯¹è±¡ */
@Column("json", { nullable: true })
@IsOptional()
settings?: Record<string, any>;
```

## ğŸ”— å…³è”å…³ç³»è§„èŒƒ

### 1. ä¸€å¯¹å¤šå…³ç³» (OneToMany/ManyToOne)
```typescript
// å­å®ä½“ (å¤šå¯¹ä¸€) - å…³è”å¯¹è±¡
@ManyToOne(() => ParentEntity, (parent) => parent.children, { nullable: true })
@JoinColumn({ name: "parent_id" })
parent?: ParentEntity;

// å­å®ä½“ (å¤šå¯¹ä¸€) - å…³è”ID
@Column("varchar", { nullable: true })
@IsString()
@IsOptional()
parentId?: string;

// çˆ¶å®ä½“ (ä¸€å¯¹å¤š)
@OneToMany(() => ChildEntity, (child) => child.parent, {
  cascade: true,
  eager: false
})
children: ChildEntity[];
```

### 2. å¤šå¯¹å¤šå…³ç³» (ManyToMany)
```typescript
// ä¸»æ§æ–¹
@ManyToMany(() => RelatedEntity, { cascade: true })
@JoinTable({
  name: "module_related",
  joinColumn: { name: "module_id", referencedColumnName: "id" },
  inverseJoinColumn: { name: "related_id", referencedColumnName: "id" },
})
relatedEntities: RelatedEntity[];

// è¢«æ§æ–¹
@ManyToMany(() => ModuleEntity, (module) => module.relatedEntities)
modules: ModuleEntity[];
```

### 3. ä¸€å¯¹ä¸€å…³ç³» (OneToOne)
```typescript
// ä¸»æ§æ–¹
@OneToOne(() => ProfileEntity, { cascade: true })
@JoinColumn({ name: "profile_id" })
profile?: ProfileEntity;

// è¢«æ§æ–¹
@OneToOne(() => UserEntity, (user) => user.profile)
user?: UserEntity;
```

### 4. æ ‘å½¢ç»“æ„å…³ç³»
```typescript
@Entity("tree_node")
@Tree("closure-table")
export class TreeNode extends BaseEntity {
  /** çˆ¶èŠ‚ç‚¹ */
  @TreeParent({ onDelete: "CASCADE" })
  parent?: TreeNode;

  /** å­èŠ‚ç‚¹ */
  @TreeChildren({ cascade: true })
  children: TreeNode[];

  /** çˆ¶èŠ‚ç‚¹ID - å†—ä½™å­—æ®µä¾¿äºæŸ¥è¯¢ */
  @Column({ nullable: true })
  @IsString()
  @IsOptional()
  parentId?: string;
}
```

## ğŸ—„ï¸ æ•°æ®åº“çº¦æŸè§„èŒƒ

### 1. ç´¢å¼•çº¦æŸ
```typescript
// å•åˆ—ç´¢å¼•
@Index()
@Column()
indexedField: string;

// å¤åˆç´¢å¼•
@Index(["field1", "field2"])
@Entity("table_name")
export class EntityName extends BaseEntity {
  @Column()
  field1: string;
  
  @Column()
  field2: string;
}

// å”¯ä¸€ç´¢å¼•
@Index({ unique: true })
@Column()
uniqueField: string;

// å¤åˆå”¯ä¸€ç´¢å¼•
@Index(["userId", "type"], { unique: true })
@Entity("user_setting")
export class UserSetting extends BaseEntity {
  @Column()
  userId: string;
  
  @Column()
  type: string;
}
```

### 2. å¤–é”®çº¦æŸ
```typescript
// çº§è”åˆ é™¤
@ManyToOne(() => ParentEntity, { onDelete: "CASCADE" })
parent: ParentEntity;

// è®¾ç½®ä¸ºç©º
@ManyToOne(() => ParentEntity, { onDelete: "SET NULL" })
parent?: ParentEntity;

// é™åˆ¶åˆ é™¤
@ManyToOne(() => ParentEntity, { onDelete: "RESTRICT" })
parent: ParentEntity;
```

## ğŸ“Š æšä¸¾å®šä¹‰è§„èŒƒ

### 1. æšä¸¾å‘½åçº¦å®š
```typescript
// æ–‡ä»¶: module.enum.ts
export enum ModuleStatus {
  ACTIVE = "active",
  INACTIVE = "inactive",
  COMPLETED = "completed",
  CANCELLED = "cancelled",
  DELETED = "deleted",
}

export enum ModuleType {
  PERSONAL = "personal",
  WORK = "work",
  STUDY = "study",
  HEALTH = "health",
}

export enum ModulePriority {
  LOW = "low",
  MEDIUM = "medium",
  HIGH = "high",
  URGENT = "urgent",
}
```

### 2. æšä¸¾ä½¿ç”¨è§„èŒƒ
```typescript
// åœ¨ Entity ä¸­ä½¿ç”¨
@Column({
  type: "enum",
  enum: ModuleStatus,
  default: ModuleStatus.ACTIVE,
})
@IsEnum(ModuleStatus)
status: ModuleStatus = ModuleStatus.ACTIVE;
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. å‘½åçº¦å®š
- **Entity ç±»å**: PascalCase (å¦‚: `UserProfile`)
- **è¡¨å**: snake_case (å¦‚: `user_profile`)
- **å­—æ®µå**: camelCase (å¦‚: `userName`)
- **æšä¸¾å**: PascalCase (å¦‚: `UserStatus`)
- **æšä¸¾å€¼**: snake_case (å¦‚: `active`, `inactive`)

### 2. å­—æ®µè®¾è®¡åŸåˆ™
- **å¿…å¡«å­—æ®µ**: ä½¿ç”¨éç©ºæ–­è¨€æ“ä½œç¬¦ `!` æ˜ç¡®æ ‡è¯†
- **å¯é€‰å­—æ®µ**: ä½¿ç”¨ `?` å¯é€‰æ ‡è®°ï¼Œç»“åˆ `nullable: true` å’Œ `@IsOptional()`
- **å…³è”å­—æ®µ**: åŒæ—¶æä¾›å…³è”å¯¹è±¡å’Œå…³è” ID å­—æ®µä¾¿äºæŸ¥è¯¢
- **æšä¸¾å­—æ®µ**: ä½¿ç”¨ `varchar` ç±»å‹å­˜å‚¨ï¼Œä¾¿äºæ‰©å±•å’ŒæŸ¥è¯¢
- **æ—¶é—´å­—æ®µ**: æ—¥æœŸä½¿ç”¨ `date` ç±»å‹ï¼Œæ—¥æœŸæ—¶é—´ä½¿ç”¨ `datetime` ç±»å‹
- **æ•°å­—å­—æ®µ**: å¯é€‰æ•°å­—å­—æ®µä½¿ç”¨ `nullable: true` å’Œ `@Type(() => Number)`

### 3. æ€§èƒ½ä¼˜åŒ–
```typescript
// é¿å… eager loadingï¼ŒæŒ‰éœ€åŠ è½½
@OneToMany(() => ChildEntity, (child) => child.parent, { 
  eager: false  // é»˜è®¤å€¼ï¼Œæ˜¾å¼å£°æ˜
})
children: ChildEntity[];

// åˆç†ä½¿ç”¨ç´¢å¼•
@Index(["status", "createdAt"])  // å¸¸ç”¨æŸ¥è¯¢æ¡ä»¶
@Entity("task")
export class Task extends BaseEntity {
  @Column()
  status: string;
}
```

### 4. æ•°æ®å®Œæ•´æ€§
```typescript
// ä½¿ç”¨æ•°æ®åº“çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
@Column({ unique: true })  // å”¯ä¸€çº¦æŸ
@IsEmail()                 // åº”ç”¨å±‚éªŒè¯
email: string;

// å¤–é”®çº¦æŸ
@ManyToOne(() => User, { onDelete: "CASCADE" })
user: User;
```

## ğŸš« ç¦æ­¢äº‹é¡¹

1. **ä¸è¦åœ¨ Entity ä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘** - Entity ä»…ç”¨äºæ•°æ®æ¨¡å‹å®šä¹‰
2. **ä¸è¦ä½¿ç”¨ `any` ç±»å‹** - åº”æ˜ç¡®å®šä¹‰å…·ä½“ç±»å‹
3. **ä¸è¦å¿½ç•¥éªŒè¯è£…é¥°å™¨** - æ‰€æœ‰å­—æ®µéƒ½åº”æœ‰é€‚å½“çš„éªŒè¯
4. **ä¸è¦ä½¿ç”¨å¤æ‚çš„è®¡ç®—å­—æ®µ** - è®¡ç®—é€»è¾‘åº”åœ¨ Service å±‚
5. **ä¸è¦åœ¨ Entity ä¸­ç›´æ¥ä½¿ç”¨ Date å¯¹è±¡è¿›è¡Œæ ¼å¼åŒ–** - æ ¼å¼åŒ–åœ¨ Mapper å±‚å¤„ç†

## âœ… æ£€æŸ¥æ¸…å•

åœ¨åˆ›å»ºæˆ–ä¿®æ”¹ Entity æ—¶ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

### åŸºç¡€ç»“æ„
- [ ] æ–‡ä»¶å‘½åç¬¦åˆè§„èŒƒ (`{module}.entity.ts`)
- [ ] ç±»å‘½åç¬¦åˆè§„èŒƒ (PascalCase)
- [ ] ç»§æ‰¿äº† BaseEntity
- [ ] è¡¨åä½¿ç”¨ snake_case
- [ ] å¯¼å…¥é¡ºåºæ­£ç¡®

### å­—æ®µå®šä¹‰
- [ ] æ‰€æœ‰å¿…å¡«å­—æ®µä½¿ç”¨éç©ºæ–­è¨€æ“ä½œç¬¦ `!`
- [ ] æ‰€æœ‰å¯é€‰å­—æ®µä½¿ç”¨ `?` æ ‡è®°å’Œ `@IsOptional()`
- [ ] å­—ç¬¦ä¸²å­—æ®µä½¿ç”¨ `@Column("varchar")`
- [ ] å¯é€‰æ•°å­—å­—æ®µä½¿ç”¨ `nullable: true` å’Œ `@Type(() => Number)`
- [ ] å¯é€‰å¸ƒå°”å­—æ®µä½¿ç”¨ `nullable: true` å’Œ `@Type(() => Boolean)`
- [ ] æšä¸¾å­—æ®µä½¿ç”¨ `varchar` ç±»å‹å’Œ `@IsEnum()`
- [ ] æ•°ç»„å­—æ®µä½¿ç”¨ `@Column("simple-array")` å’Œ `@IsArray() @IsString({ each: true })`

### å…³è”å…³ç³»
- [ ] å…³è”å…³ç³»å®šä¹‰æ­£ç¡®
- [ ] å¤–é”®çº¦æŸè®¾ç½®åˆç†
- [ ] çº§è”æ“ä½œé…ç½®æ­£ç¡®
- [ ] æä¾›äº†å¯¹åº”çš„ ID å­—æ®µ

### æ•°æ®åº“çº¦æŸ
- [ ] å”¯ä¸€å­—æ®µæ·»åŠ äº† `unique: true`
- [ ] å¿…è¦çš„å­—æ®µæ·»åŠ äº†ç´¢å¼•
- [ ] å¤–é”®çº¦æŸé…ç½®æ­£ç¡®
- [ ] é»˜è®¤å€¼è®¾ç½®åˆç†

### æšä¸¾å®šä¹‰
- [ ] æšä¸¾å€¼ä½¿ç”¨å°å†™å­—ç¬¦ä¸²
- [ ] æšä¸¾åç§°è¯­ä¹‰æ¸…æ™°
- [ ] åœ¨ Entity ä¸­æ­£ç¡®ä½¿ç”¨æšä¸¾

### æ€§èƒ½è€ƒè™‘
- [ ] é¿å…äº†ä¸å¿…è¦çš„ eager loading
- [ ] æ·»åŠ äº†å¿…è¦çš„ç´¢å¼•
- [ ] å…³è”å…³ç³»é…ç½®åˆç†

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```typescript
// module.enum.ts
export enum ModuleStatus {
  ACTIVE = "active",
  INACTIVE = "inactive",
  COMPLETED = "completed",
}

export enum ModuleType {
  PERSONAL = "personal",
  WORK = "work",
  STUDY = "study",
}

// module.entity.ts
import { BaseEntity } from "../../base/base.entity";
import { ModuleStatus, ModuleType } from "@life-toolkit/enum";
import { RelatedEntity } from "../related";
import { Entity, Column, ManyToOne, JoinColumn } from "typeorm";
import {
  IsString,
  IsOptional,
  IsEnum,
  IsArray,
  IsNumber,
  IsISO8601,
} from "class-validator";
import { Type } from "class-transformer";

export class ModuleModel extends BaseEntity {
  /** æ ‡é¢˜ - å­—ç¬¦ä¸²ç±»å‹ */
  @Column("varchar")
  @IsString()
  title!: string;

  /** æè¿° - å¯é€‰å­—ç¬¦ä¸² */
  @Column("text", { nullable: true })
  @IsString()
  @IsOptional()
  description?: string;

  /** é‡è¦ç¨‹åº¦ - æ•°å­—ç±»å‹ */
  @Column("int", { nullable: true })
  @IsNumber()
  @IsOptional()
  @Type(() => Number)
  importance?: number;

  /** çŠ¶æ€ - æšä¸¾ç±»å‹ */
  @Column({
    type: "varchar",
    length: 20,
    nullable: true,
  })
  @IsEnum(ModuleStatus)
  status!: ModuleStatus;

  /** æ ‡ç­¾ - æ•°ç»„ç±»å‹ */
  @Column("simple-array")
  @IsArray()
  @IsString({ each: true })
  tags!: string[];

  /** è®¡åˆ’æ—¥æœŸ - æ—¥æœŸç±»å‹ */
  @Column("date")
  @IsISO8601()
  planDate: Date = new Date();

  /** å®Œæˆæ—¶é—´ - å¯é€‰æ—¥æœŸæ—¶é—´ */
  @Column("datetime", {
    nullable: true,
  })
  doneAt?: Date;
}

@Entity("module")
export class Module extends ModuleModel {
  /** å…³è”å¯¹è±¡ - å…³è”å…³ç³» */
  @ManyToOne(() => RelatedEntity, (related) => related.modules, { nullable: true })
  @JoinColumn({ name: "related_id" })
  related?: RelatedEntity;

  /** å…³è”ID - å…³è”å­—æ®µ */
  @Column("varchar", { nullable: true })
  @IsString()
  @IsOptional()
  relatedId?: string;
}
```
