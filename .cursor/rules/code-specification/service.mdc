---
description: ç¼–å†™server Serviceä»£ç æ—¶
alwaysApply: false
---
# Service è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬è§„èŒƒå®šä¹‰äº† Life Toolkit é¡¹ç›®ä¸­ä¸šåŠ¡æœåŠ¡å±‚çš„æ ‡å‡†ç»“æ„ã€æ–¹æ³•å‘½åã€ä¾èµ–æ³¨å…¥ã€æ•°æ®å¤„ç†ç­‰è§„èŒƒï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

## ğŸ—ï¸ åŸºç¡€æ¶æ„

### 1. æœåŠ¡ç±»ç»“æ„
```typescript
import { ModuleRepository, RelatedService } from "./module.repository";
import {
  CreateModuleDto,
  UpdateModuleDto,
  ModulePageFiltersDto,
  ModuleListFilterDto,
  ModuleDto,
} from "./dto";
import { ModuleStatus } from "@life-toolkit/enum";

export class ModuleService {
  protected relatedService: RelatedService;
  protected moduleRepository: ModuleRepository;

  constructor(
    relatedService: RelatedService,
    moduleRepository: ModuleRepository
  ) {
    this.relatedService = relatedService;
    this.moduleRepository = moduleRepository;
  }
}
```

### 2. ä¾èµ–æ³¨å…¥è§„èŒƒ
- **æ„é€ å‡½æ•°æ³¨å…¥**: æ‰€æœ‰ä¾èµ–é€šè¿‡æ„é€ å‡½æ•°å‚æ•°æ³¨å…¥
- **å±æ€§å£°æ˜**: ä½¿ç”¨ `protected` ä¿®é¥°ç¬¦å£°æ˜ä¾èµ–å±æ€§
- **ç«‹å³èµ‹å€¼**: åœ¨æ„é€ å‡½æ•°ä¸­ç«‹å³å°†å‚æ•°èµ‹å€¼ç»™å±æ€§

## ğŸ¯ æ–¹æ³•è§„èŒƒ

### 1. åŸºç¡€ CRUD æ–¹æ³•

#### åˆ›å»ºæ–¹æ³• (create)
```typescript
async create(createDto: CreateModuleDto): Promise<ModuleDto> {
  const module = await this.moduleRepository.create(createDto);

  // å¤„ç†å…³è”æ•°æ®
  if ((createDto as any).relatedConfig) {
    const related = await this.relatedService.create({
      ...(createDto as any).relatedConfig,
      // åŒæ­¥ç›¸å…³ä¸šåŠ¡å­—æ®µ
      name: (createDto as any).name,
      description: (createDto as any).description,
    });
    await this.moduleRepository.updateRelatedId(
      (module as any).id,
      (related as any).id
    );
  }

  return await this.moduleRepository.findWithRelations((module as any).id);
}
```

#### æŸ¥è¯¢æ–¹æ³•æ—
```typescript
// æŸ¥æ‰¾æ‰€æœ‰è®°å½•
async findByFilter(filter: ModuleListFilterDto): Promise<ModuleDto[]> {
  return await this.moduleRepository.findByFilter(filter);
}

// åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¯èƒ½åŒ…å«é¢å¤–å¤„ç†ï¼‰
async list(filter: ModuleListFilterDto): Promise<ModuleDto[]> {
  const list = await this.moduleRepository.findByFilter(filter);
  return list;
}

// åˆ†é¡µæŸ¥è¯¢
async page(
  filter: ModulePageFiltersDto
): Promise<{ list: ModuleDto[]; total: number; pageNum: number; pageSize: number }> {
  const { list, total, pageNum, pageSize } =
    await this.moduleRepository.page(filter);
  return { list, total, pageNum, pageSize };
}

// æ ¹æ®IDæŸ¥æ‰¾å•ä¸ªè®°å½•
async findWithRelations(id: string): Promise<ModuleDto> {
  return await this.moduleRepository.findWithRelations(id);
}
```

#### æ›´æ–°æ–¹æ³• (update)
```typescript
async update(id: string, updateDto: UpdateModuleDto): Promise<ModuleDto> {
  const module = await this.moduleRepository.update(id, updateDto);

  // å¤„ç†å…³è”æ•°æ®æ›´æ–°
  if ((updateDto as any).relatedConfig) {
    await this.relatedService.update((module as any).id, {
      ...(updateDto as any).relatedConfig,
      // åŒæ­¥ç›¸å…³ä¸šåŠ¡å­—æ®µ
      name: (updateDto as any).name,
      description: (updateDto as any).description,
    });
  }

  return await this.moduleRepository.findWithRelations(id);
}
```

#### åˆ é™¤æ–¹æ³• (delete)
```typescript
async delete(id: string): Promise<boolean> {
  return await this.moduleRepository.delete(id);
}
```

### 2. çŠ¶æ€ç®¡ç†æ–¹æ³•

#### çŠ¶æ€å˜æ›´æ–¹æ³•
```typescript
async changeStatus(id: string, newStatus: ModuleStatus): Promise<any> {
  const updateDto = new UpdateModuleDto();
  updateDto.status = newStatus;
  updateDto.statusChangedAt = new Date();
  await this.moduleRepository.update(id, updateDto);
}

async markDone(id: string): Promise<any> {
  const updateDto = new UpdateModuleDto();
  updateDto.status = ModuleStatus.DONE;
  updateDto.doneAt = new Date();
  await this.moduleRepository.update(id, updateDto);
}

async markAbandoned(id: string): Promise<any> {
  const updateDto = new UpdateModuleDto();
  updateDto.status = ModuleStatus.ABANDONED;
  updateDto.abandonedAt = new Date();
  await this.moduleRepository.update(id, updateDto);
}

async restore(id: string): Promise<any> {
  const updateDto = new UpdateModuleDto();
  updateDto.status = ModuleStatus.ACTIVE;
  updateDto.doneAt = null as any;
  updateDto.abandonedAt = null as any;
  await this.moduleRepository.update(id, updateDto);
}
```

### 3. æ‰¹é‡æ“ä½œæ–¹æ³•

#### æ‰¹é‡çŠ¶æ€å˜æ›´
```typescript
async batchChangeStatus(params: { includeIds: string[]; status: ModuleStatus }): Promise<any> {
  if (!params?.includeIds?.length) return;

  const updateDto = new UpdateModuleDto();
  updateDto.status = params.status;
  updateDto.statusChangedAt = new Date();
  await this.moduleRepository.batchUpdate(params.includeIds, updateDto);
}
```

#### æŒ‰å…³è”IDåˆ é™¤
```typescript
async deleteByRelatedIds(relatedIds: string[]): Promise<void> {
  if (!relatedIds || relatedIds.length === 0) return;
  await this.moduleRepository.softDeleteByRelatedIds(relatedIds);
}
```

## ğŸ“Š æ•°æ®å¤„ç†è§„èŒƒ

### 1. ç±»å‹æ–­è¨€ä½¿ç”¨
```typescript
// åœ¨å¤„ç†åŠ¨æ€å­—æ®µæˆ–å…³è”æ•°æ®æ—¶ä½¿ç”¨ç±»å‹æ–­è¨€
if ((createDto as any).relatedConfig) {
  // å¤„ç†å…³è”é…ç½®
}

// å¤„ç†çŠ¶æ€å˜æ›´æ—¶é—´æˆ³
updateDto.doneAt = null as any; // æ¸…é™¤æ—¶é—´æˆ³
```

### 2. DTO å®ä¾‹åŒ–
```typescript
// åˆ›å»º DTO å®ä¾‹è¿›è¡ŒçŠ¶æ€å˜æ›´
const updateDto = new UpdateModuleDto();
updateDto.status = ModuleStatus.DONE;
updateDto.doneAt = new Date();
```

### 3. å…³è”æ•°æ®åŒæ­¥
```typescript
// åŒæ­¥ä¸šåŠ¡å­—æ®µåˆ°å…³è”å¯¹è±¡
const relatedConfig = {
  ...(createDto as any).relatedConfig,
  name: (createDto as any).name,
  description: (createDto as any).description,
  tags: (createDto as any).tags,
};
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. æ–¹æ³•å‘½åçº¦å®š
- **åŸºç¡€æ“ä½œ**: `create`, `findByFilter`, `update`, `delete`, `findWithRelations`
- **æŸ¥è¯¢å˜ä½“**: `list` (ç®€å•æŸ¥è¯¢), `page` (åˆ†é¡µæŸ¥è¯¢)
- **çŠ¶æ€å˜æ›´**: `markDone`, `markAbandoned`, `restore`
- **æ‰¹é‡æ“ä½œ**: `batchChangeStatus`, `deleteByRelatedIds`

### 2. é”™è¯¯å¤„ç†åŸåˆ™
- **å‚æ•°æ ¡éªŒ**: åœ¨æ–¹æ³•å¼€å§‹å¤„æ ¡éªŒå¿…è¦å‚æ•°
- **ç©ºå€¼æ£€æŸ¥**: æ£€æŸ¥æ•°ç»„å‚æ•°æ˜¯å¦ä¸ºç©º
- **å¼‚å¸¸æŠ›å‡º**: è®©åº•å±‚ Repository å¤„ç†å…·ä½“å¼‚å¸¸

### 3. æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡æ“ä½œ**: ä¼˜å…ˆä½¿ç”¨æ‰¹é‡æ›´æ–°æ–¹æ³•
- **å…³è”æŸ¥è¯¢**: è®© Repository å¤„ç†å…³è”æ•°æ®çš„å»¶è¿ŸåŠ è½½
- **åˆ†é¡µæŸ¥è¯¢**: ç»Ÿä¸€è¿”å›åˆ†é¡µç»“æœæ ¼å¼

### 4. æ•°æ®ä¸€è‡´æ€§
- **å…³è”æ•°æ®**: åˆ›å»ºæ—¶åŒæ­¥å…³è”æ•°æ®
- **çŠ¶æ€ç®¡ç†**: çŠ¶æ€å˜æ›´æ—¶æ¸…ç†ç›¸å…³æ—¶é—´æˆ³
- **è½¯åˆ é™¤**: ä½¿ç”¨è½¯åˆ é™¤ä¿æŒæ•°æ®å®Œæ•´æ€§

## ğŸš« ç¦æ­¢äº‹é¡¹

1. **ä¸è¦åœ¨ Service ä¸­ç›´æ¥æ“ä½œ Entity** - é€šè¿‡ Repository å±‚è®¿é—®æ•°æ®
2. **ä¸è¦åœ¨ Service ä¸­å¤„ç† HTTP è¯·æ±‚/å“åº”** - è¿™æ˜¯ Controller çš„èŒè´£
3. **ä¸è¦åœ¨ Service ä¸­è¿›è¡Œå¤æ‚çš„ä¸šåŠ¡è®¡ç®—** - å¤æ‚é€»è¾‘åº”æ‹†åˆ†åˆ°å•ç‹¬çš„æœåŠ¡
4. **ä¸è¦å¿½ç•¥å…³è”æ•°æ®çš„åŒæ­¥** - ç¡®ä¿å…³è”æ•°æ®çš„ä¸€è‡´æ€§
5. **ä¸è¦ç›´æ¥ä½¿ç”¨ `any` ç±»å‹** - é™¤éå¤„ç†åŠ¨æ€é…ç½®æˆ–ç‰¹æ®Šæƒ…å†µ

## âœ… æ£€æŸ¥æ¸…å•

åœ¨åˆ›å»ºæˆ–ä¿®æ”¹ Service æ—¶ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

### åŸºç¡€ç»“æ„
- [ ] ç±»åç¬¦åˆè§„èŒƒ (PascalCase)
- [ ] ä½¿ç”¨äº†ä¾èµ–æ³¨å…¥æ¨¡å¼
- [ ] å¯¼å…¥äº†å¿…è¦çš„ DTO å’Œæšä¸¾
- [ ] æ„é€ å‡½æ•°æ­£ç¡®èµ‹å€¼ä¾èµ–

### æ–¹æ³•å®ç°
- [ ] å®ç°äº†æ ‡å‡†çš„ CRUD æ–¹æ³•
- [ ] æŸ¥è¯¢æ–¹æ³•è¿”å›æ­£ç¡®çš„ DTO ç±»å‹
- [ ] æ›´æ–°æ–¹æ³•å¤„ç†äº†å…³è”æ•°æ®åŒæ­¥
- [ ] çŠ¶æ€å˜æ›´æ–¹æ³•æ­£ç¡®æ›´æ–°æ—¶é—´æˆ³

### æ•°æ®å¤„ç†
- [ ] ä½¿ç”¨äº†é€‚å½“çš„ç±»å‹æ–­è¨€
- [ ] DTO å®ä¾‹åŒ–æ­£ç¡®
- [ ] å…³è”æ•°æ®åŒæ­¥é€»è¾‘å®Œæ•´
- [ ] æ‰¹é‡æ“ä½œæœ‰å‚æ•°æ ¡éªŒ

### ä¸šåŠ¡é€»è¾‘
- [ ] çŠ¶æ€ç®¡ç†é€»è¾‘æ­£ç¡®
- [ ] å…³è”æ•°æ®åˆ›å»º/æ›´æ–°å¤„ç†å®Œæ•´
- [ ] é”™è¯¯æƒ…å†µå¤„ç†åˆç†

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```typescript
import { ModuleRepository, RelatedService } from "./module.repository";
import {
  CreateModuleDto,
  UpdateModuleDto,
  ModulePageFiltersDto,
  ModuleListFilterDto,
  ModuleDto,
} from "./dto";
import { ModuleStatus } from "@life-toolkit/enum";

export class ModuleService {
  protected relatedService: RelatedService;
  protected moduleRepository: ModuleRepository;

  constructor(
    relatedService: RelatedService,
    moduleRepository: ModuleRepository
  ) {
    this.relatedService = relatedService;
    this.moduleRepository = moduleRepository;
  }

  async create(createDto: CreateModuleDto): Promise<ModuleDto> {
    const module = await this.moduleRepository.create(createDto);

    if ((createDto as any).relatedConfig) {
      const related = await this.relatedService.create({
        ...(createDto as any).relatedConfig,
        name: (createDto as any).name,
        description: (createDto as any).description,
        tags: (createDto as any).tags,
      });
      await this.moduleRepository.updateRelatedId(
        (module as any).id,
        (related as any).id
      );
    }

    return await this.moduleRepository.findWithRelations((module as any).id);
  }

  async findByFilter(filter: ModuleListFilterDto): Promise<ModuleDto[]> {
    return await this.moduleRepository.findByFilter(filter);
  }

  async page(
    filter: ModulePageFiltersDto
  ): Promise<{ list: ModuleDto[]; total: number; pageNum: number; pageSize: number }> {
    const { list, total, pageNum, pageSize } =
      await this.moduleRepository.page(filter);
    return { list, total, pageNum, pageSize };
  }

  async update(id: string, updateDto: UpdateModuleDto): Promise<ModuleDto> {
    const module = await this.moduleRepository.update(id, updateDto);

    if ((updateDto as any).relatedConfig) {
      await this.relatedService.update((module as any).id, {
        ...(updateDto as any).relatedConfig,
        name: (updateDto as any).name,
        description: (updateDto as any).description,
      });
    }

    return await this.moduleRepository.findWithRelations(id);
  }

  async delete(id: string): Promise<boolean> {
    return await this.moduleRepository.delete(id);
  }

  async findWithRelations(id: string): Promise<ModuleDto> {
    return await this.moduleRepository.findWithRelations(id);
  }

  async deleteByRelatedIds(relatedIds: string[]): Promise<void> {
    if (!relatedIds || relatedIds.length === 0) return;
    await this.moduleRepository.softDeleteByRelatedIds(relatedIds);
  }

  async batchMarkDone(params: { includeIds: string[] }): Promise<any> {
    if (!params?.includeIds?.length) return;
    const updateDto = new UpdateModuleDto();
    updateDto.status = ModuleStatus.DONE;
    updateDto.doneAt = new Date();
    await this.moduleRepository.batchUpdate(params.includeIds, updateDto);
  }

  async markDone(id: string): Promise<any> {
    const updateDto = new UpdateModuleDto();
    updateDto.status = ModuleStatus.DONE;
    updateDto.doneAt = new Date();
    await this.moduleRepository.update(id, updateDto);
  }

  async restore(id: string): Promise<any> {
    const updateDto = new UpdateModuleDto();
    updateDto.status = ModuleStatus.ACTIVE;
    updateDto.doneAt = null as any;
    updateDto.abandonedAt = null as any;
    await this.moduleRepository.update(id, updateDto);
  }
}
```
