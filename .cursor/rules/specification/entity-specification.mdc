---
description: éœ€è¦å¢åˆ æ”¹æŸ¥Entityä¸­ä»£ç æ—¶
globs: 
alwaysApply: false
---
# Entity çº¦æŸè§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬è§„èŒƒå®šä¹‰äº† Life Toolkit é¡¹ç›®ä¸­ TypeORM Entity çš„æ ‡å‡†ç»“æ„ã€è£…é¥°å™¨ä½¿ç”¨ã€éªŒè¯çº¦æŸç­‰è§„èŒƒï¼Œç¡®ä¿æ•°æ®æ¨¡å‹çš„ä¸€è‡´æ€§ã€ç±»å‹å®‰å…¨å’Œæ•°æ®å®Œæ•´æ€§ã€‚

## ğŸ—ï¸ åŸºç¡€æ¶æ„

### ç»§æ‰¿ç»“æ„
```typescript
// æ‰€æœ‰ä¸šåŠ¡ Entity å¿…é¡»ç»§æ‰¿ BaseEntity
import { BaseEntity } from "@/base/base.entity";

@Entity("table_name")
export class BusinessEntity extends BaseEntity {
  // ä¸šåŠ¡å­—æ®µå®šä¹‰
}
```

### BaseEntity æä¾›çš„åŸºç¡€å­—æ®µ
```typescript
export class BaseEntity {
  @PrimaryGeneratedColumn("uuid")
  id: string;                    // ä¸»é”® (UUID)

  @CreateDateColumn()
  createdAt: Date;              // åˆ›å»ºæ—¶é—´

  @UpdateDateColumn()
  updatedAt: Date;              // æ›´æ–°æ—¶é—´

  @DeleteDateColumn({ nullable: true })
  deletedAt?: Date;             // è½¯åˆ é™¤æ—¶é—´
}
```

## ğŸ¯ Entity å®šä¹‰è§„èŒƒ

### 1. å¯¼å…¥é¡ºåº
```typescript
// 1. TypeORM è£…é¥°å™¨
import { Entity, Column, OneToMany, ManyToOne, JoinTable } from "typeorm";

// 2. éªŒè¯è£…é¥°å™¨
import {
  IsString,
  IsOptional,
  IsEnum,
  IsArray,
  IsNumber,
  IsBoolean,
  IsInt,
  Min,
  Max,
  IsISO8601,
} from "class-validator";

// 3. è½¬æ¢è£…é¥°å™¨
import { Type } from "class-transformer";

// 4. åŸºç¡€ç±»å’Œæšä¸¾
import { BaseEntity } from "@/base/base.entity";
import { EnumType } from "./enum";

// 5. å…³è”å®ä½“
import { RelatedEntity } from "../related/entities";
```

### 2. Entity è£…é¥°å™¨
```typescript
// æ ‡å‡†æ ¼å¼ï¼šè¡¨åä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
@Entity("table_name")
export class EntityName extends BaseEntity {
  // å­—æ®µå®šä¹‰
}

// æ ‘å½¢ç»“æ„å®ä½“
@Entity("table_name")
@Tree("closure-table")
export class TreeEntity extends BaseEntity {
  // å­—æ®µå®šä¹‰
}
```

### 3. æšä¸¾å®šä¹‰
```typescript
// æšä¸¾å¿…é¡»å®šä¹‰åœ¨ Entity æ–‡ä»¶ä¸­æˆ–å•ç‹¬çš„ enum æ–‡ä»¶ä¸­
export enum EntityStatus {
  ACTIVE = "active",
  INACTIVE = "inactive",
  DELETED = "deleted",
}

export enum EntityType {
  TYPE_A = "type_a",
  TYPE_B = "type_b",
}
```

## ğŸ“ å­—æ®µå®šä¹‰è§„èŒƒ

### 1. åŸºç¡€å­—æ®µæ¨¡å¼
```typescript
/** å­—æ®µæè¿° */
@Column(columnOptions)
@ValidationDecorator()
@TransformDecorator()
fieldName: FieldType;
```

### 2. å­—ç¬¦ä¸²å­—æ®µ
```typescript
/** å¿…å¡«å­—ç¬¦ä¸²å­—æ®µ */
@Column()
@IsString()
name: string;

/** å¯é€‰å­—ç¬¦ä¸²å­—æ®µ */
@Column({ nullable: true })
@IsString()
@IsOptional()
description?: string;

/** é•¿æ–‡æœ¬å­—æ®µ */
@Column("text", { nullable: true })
@IsString()
@IsOptional()
content?: string;
```

### 3. æ•°å­—å­—æ®µ
```typescript
/** æ•´æ•°å­—æ®µ */
@Column({ default: 0 })
@IsNumber()
@Type(() => Number)
count: number = 0;

/** å¸¦èŒƒå›´é™åˆ¶çš„æ•´æ•° */
@Column({ default: 3 })
@IsNumber()
@IsOptional()
@Type(() => Number)
@IsInt()
@Min(1)
@Max(5)
importance?: number = 3;

/** å°æ•°å­—æ®µ */
@Column("decimal", { precision: 10, scale: 2 })
@IsNumber()
@Type(() => Number)
amount: number;
```

### 4. å¸ƒå°”å­—æ®µ
```typescript
/** å¸ƒå°”å­—æ®µ */
@Column({ default: false })
@IsBoolean()
@Type(() => Boolean)
isActive: boolean = false;
```

### 5. æšä¸¾å­—æ®µ
```typescript
/** å¿…å¡«æšä¸¾å­—æ®µ */
@Column({
  type: "enum",
  enum: EntityStatus,
  default: EntityStatus.ACTIVE,
})
@IsEnum(EntityStatus)
status: EntityStatus;

/** å¯é€‰æšä¸¾å­—æ®µ */
@Column({
  type: "enum",
  enum: EntityType,
  nullable: true,
})
@IsEnum(EntityType)
@IsOptional()
type?: EntityType;
```

### 6. æ—¥æœŸæ—¶é—´å­—æ®µ
```typescript
/** æ—¥æœŸå­—æ®µ */
@Column("date")
@IsISO8601()
startDate: Date = new Date();

/** å¯é€‰æ—¥æœŸå­—æ®µ */
@Column("date", { nullable: true })
@IsISO8601()
@IsOptional()
endDate?: Date;

/** æ—¥æœŸæ—¶é—´å­—æ®µ */
@Column("datetime", { nullable: true })
@IsOptional()
createdAt?: Date;

/** æ—¶é—´å­—æ®µ */
@Column("time", { nullable: true })
@IsOptional()
startTime?: string;
```

### 7. æ•°ç»„å­—æ®µ
```typescript
/** å­—ç¬¦ä¸²æ•°ç»„ */
@Column("simple-array", { nullable: true })
@IsArray()
@IsString({ each: true })
tags: string[];

/** JSON æ•°ç»„ */
@Column("json", { nullable: true })
@IsArray()
@IsOptional()
metadata?: any[];
```

### 8. JSON å­—æ®µ
```typescript
/** JSON å¯¹è±¡ */
@Column("json", { nullable: true })
@IsOptional()
settings?: {
  key: string;
  value: any;
};
```

## ğŸ”— å…³è”å…³ç³»è§„èŒƒ

### 1. ä¸€å¯¹å¤šå…³ç³» (OneToMany)
```typescript
/** ä¸€å¯¹å¤šå…³ç³» - ä¸»è¡¨ä¾§ */
@OneToMany(() => ChildEntity, (child) => child.parent, { cascade: true })
children: ChildEntity[];

/** å¤šå¯¹ä¸€å…³ç³» - ä»è¡¨ä¾§ */
@ManyToOne(() => ParentEntity, (parent) => parent.children)
parent?: ParentEntity;

/** å¤–é”®å­—æ®µ */
@Column({ nullable: true })
@IsString()
@IsOptional()
parentId?: string;
```

### 2. å¤šå¯¹å¤šå…³ç³» (ManyToMany)
```typescript
/** å¤šå¯¹å¤šå…³ç³» - ä¸»æ§æ–¹ */
@ManyToMany(() => RelatedEntity, { cascade: true })
@JoinTable({
  name: "entity_related",
  joinColumn: { name: "entity_id", referencedColumnName: "id" },
  inverseJoinColumn: { name: "related_id", referencedColumnName: "id" },
})
relatedEntities: RelatedEntity[];

/** å¤šå¯¹å¤šå…³ç³» - è¢«æ§æ–¹ */
@ManyToMany(() => MainEntity, (main) => main.relatedEntities)
mainEntities: MainEntity[];
```

### 3. æ ‘å½¢ç»“æ„å…³ç³»
```typescript
/** çˆ¶èŠ‚ç‚¹ */
@TreeParent({
  onDelete: "CASCADE",
})
parent?: EntityName;

/** å­èŠ‚ç‚¹ */
@TreeChildren({
  cascade: true,
})
children: EntityName[];
```

### 4. ä¸€å¯¹ä¸€å…³ç³» (OneToOne)
```typescript
/** ä¸€å¯¹ä¸€å…³ç³» - ä¸»æ§æ–¹ */
@OneToOne(() => RelatedEntity, { cascade: true })
@JoinColumn({ name: "related_id" })
related?: RelatedEntity;

/** ä¸€å¯¹ä¸€å…³ç³» - è¢«æ§æ–¹ */
@OneToOne(() => MainEntity, (main) => main.related)
main?: MainEntity;
```

## âœ… éªŒè¯è£…é¥°å™¨è§„èŒƒ

### 1. åŸºç¡€éªŒè¯
```typescript
// å­—ç¬¦ä¸²éªŒè¯
@IsString()                    // å­—ç¬¦ä¸²ç±»å‹
@IsOptional()                  // å¯é€‰å­—æ®µ

// æ•°å­—éªŒè¯
@IsNumber()                    // æ•°å­—ç±»å‹
@IsInt()                       // æ•´æ•°
@Min(1)                        // æœ€å°å€¼
@Max(100)                      // æœ€å¤§å€¼

// å¸ƒå°”éªŒè¯
@IsBoolean()                   // å¸ƒå°”ç±»å‹

// æšä¸¾éªŒè¯
@IsEnum(EnumType)              // æšä¸¾ç±»å‹

// æ•°ç»„éªŒè¯
@IsArray()                     // æ•°ç»„ç±»å‹
@IsString({ each: true })      // æ•°ç»„å…ƒç´ éªŒè¯

// æ—¥æœŸéªŒè¯
@IsISO8601()                   // ISO 8601 æ—¥æœŸæ ¼å¼
```

### 2. ç±»å‹è½¬æ¢
```typescript
@Type(() => Number)            // è½¬æ¢ä¸ºæ•°å­—
@Type(() => Boolean)           // è½¬æ¢ä¸ºå¸ƒå°”å€¼
@Type(() => Date)              // è½¬æ¢ä¸ºæ—¥æœŸ
```

### 3. å¤åˆéªŒè¯ç¤ºä¾‹
```typescript
/** è¯„åˆ†å­—æ®µ (1-5 çš„æ•´æ•°) */
@Column({ default: 3 })
@IsNumber()
@IsOptional()
@Type(() => Number)
@IsInt()
@Min(1)
@Max(5)
rating?: number = 3;

/** é‚®ç®±å­—æ®µ */
@Column({ unique: true })
@IsEmail()
@IsString()
email: string;

/** URL å­—æ®µ */
@Column({ nullable: true })
@IsUrl()
@IsString()
@IsOptional()
website?: string;
```

## ğŸ—„ï¸ æ•°æ®åº“çº¦æŸè§„èŒƒ

### 1. åˆ—çº¦æŸ
```typescript
// éç©ºçº¦æŸ
@Column()                      // é»˜è®¤éç©º
@Column({ nullable: false })   // æ˜¾å¼éç©º

// å¯ç©ºçº¦æŸ
@Column({ nullable: true })    // å¯ç©º

// é»˜è®¤å€¼
@Column({ default: "default_value" })
@Column({ default: 0 })
@Column({ default: false })

// å”¯ä¸€çº¦æŸ
@Column({ unique: true })

// é•¿åº¦çº¦æŸ
@Column({ length: 255 })
@Column("varchar", { length: 100 })
```

### 2. ç´¢å¼•çº¦æŸ
```typescript
// å•åˆ—ç´¢å¼•
@Index()
@Column()
indexedField: string;

// å¤åˆç´¢å¼•
@Index(["field1", "field2"])
@Entity("table_name")
export class EntityName extends BaseEntity {
  @Column()
  field1: string;
  
  @Column()
  field2: string;
}

// å”¯ä¸€ç´¢å¼•
@Index({ unique: true })
@Column()
uniqueField: string;
```

### 3. å¤–é”®çº¦æŸ
```typescript
// çº§è”åˆ é™¤
@ManyToOne(() => ParentEntity, { onDelete: "CASCADE" })
parent: ParentEntity;

// è®¾ç½®ä¸ºç©º
@ManyToOne(() => ParentEntity, { onDelete: "SET NULL" })
parent?: ParentEntity;

// é™åˆ¶åˆ é™¤
@ManyToOne(() => ParentEntity, { onDelete: "RESTRICT" })
parent: ParentEntity;
```

## ğŸ“Š æ•°æ®ç±»å‹æ˜ å°„

### 1. TypeORM æ•°æ®ç±»å‹
```typescript
// å­—ç¬¦ä¸²ç±»å‹
@Column()                      // varchar(255)
@Column("text")                // text
@Column("varchar", { length: 100 }) // varchar(100)

// æ•°å­—ç±»å‹
@Column("int")                 // int
@Column("bigint")              // bigint
@Column("decimal", { precision: 10, scale: 2 }) // decimal(10,2)
@Column("float")               // float
@Column("double")              // double

// æ—¥æœŸæ—¶é—´ç±»å‹
@Column("date")                // date
@Column("time")                // time
@Column("datetime")            // datetime
@Column("timestamp")           // timestamp

// å¸ƒå°”ç±»å‹
@Column("boolean")             // boolean

// JSON ç±»å‹
@Column("json")                // json
@Column("simple-array")        // ç®€å•æ•°ç»„å­˜å‚¨
```

### 2. ç‰¹æ®Šå­—æ®µç±»å‹
```typescript
// UUID ä¸»é”®
@PrimaryGeneratedColumn("uuid")
id: string;

// è‡ªå¢ä¸»é”®
@PrimaryGeneratedColumn()
id: number;

// è‡ªåŠ¨æ—¶é—´æˆ³
@CreateDateColumn()
createdAt: Date;

@UpdateDateColumn()
updatedAt: Date;

@DeleteDateColumn()
deletedAt?: Date;
```

## ğŸ”§ æœ€ä½³å®è·µ

### 1. å‘½åçº¦å®š
```typescript
// Entity ç±»åï¼šPascalCase
export class UserProfile extends BaseEntity {}

// è¡¨åï¼šsnake_case
@Entity("user_profile")

// å­—æ®µåï¼šcamelCase
userName: string;

// æšä¸¾å€¼ï¼šUPPER_SNAKE_CASE
export enum UserStatus {
  ACTIVE = "active",
  INACTIVE = "inactive",
}
```

### 2. æ³¨é‡Šè§„èŒƒ
```typescript
export class User extends BaseEntity {
  /** ç”¨æˆ·å - å¿…å¡«ï¼Œå”¯ä¸€ */
  @Column({ unique: true })
  @IsString()
  username: string;

  /** ç”¨æˆ·çŠ¶æ€ - é»˜è®¤æ¿€æ´» */
  @Column({
    type: "enum",
    enum: UserStatus,
    default: UserStatus.ACTIVE,
  })
  @IsEnum(UserStatus)
  status: UserStatus;
}
```

### 3. é»˜è®¤å€¼å¤„ç†
```typescript
// åœ¨ Entity ä¸­è®¾ç½®é»˜è®¤å€¼
@Column({ default: 0 })
@IsNumber()
@Type(() => Number)
count: number = 0;

// åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®é»˜è®¤å€¼
constructor() {
  super();
  this.tags = [];
  this.status = EntityStatus.ACTIVE;
}
```

### 4. è½¯åˆ é™¤æ”¯æŒ
```typescript
// ç»§æ‰¿ BaseEntity è‡ªåŠ¨è·å¾—è½¯åˆ é™¤æ”¯æŒ
export class SoftDeleteEntity extends BaseEntity {
  // deletedAt å­—æ®µç”± BaseEntity æä¾›
}

// åœ¨ Repository ä¸­ä½¿ç”¨è½¯åˆ é™¤
const entity = await repository.softDelete(id);
const entities = await repository.find(); // è‡ªåŠ¨æ’é™¤å·²åˆ é™¤è®°å½•
```

## ğŸš¨ å¸¸è§é”™è¯¯é¿å…

### 1. éªŒè¯è£…é¥°å™¨é”™è¯¯
```typescript
// âŒ é”™è¯¯ï¼šç¼ºå°‘ç±»å‹è½¬æ¢
@Column()
@IsNumber()
count: number;

// âœ… æ­£ç¡®ï¼šæ·»åŠ ç±»å‹è½¬æ¢
@Column()
@IsNumber()
@Type(() => Number)
count: number;
```

### 2. å¯é€‰å­—æ®µé”™è¯¯
```typescript
// âŒ é”™è¯¯ï¼šå¯é€‰å­—æ®µç¼ºå°‘ @IsOptional()
@Column({ nullable: true })
@IsString()
description?: string;

// âœ… æ­£ç¡®ï¼šæ·»åŠ  @IsOptional()
@Column({ nullable: true })
@IsString()
@IsOptional()
description?: string;
```

### 3. å…³è”å…³ç³»é”™è¯¯
```typescript
// âŒ é”™è¯¯ï¼šç¼ºå°‘å¤–é”®å­—æ®µ
@ManyToOne(() => Parent)
parent?: Parent;

// âœ… æ­£ç¡®ï¼šæ·»åŠ å¤–é”®å­—æ®µ
@ManyToOne(() => Parent)
parent?: Parent;

@Column({ nullable: true })
@IsString()
@IsOptional()
parentId?: string;
```

### 4. æšä¸¾å­—æ®µé”™è¯¯
```typescript
// âŒ é”™è¯¯ï¼šæšä¸¾é…ç½®ä¸å®Œæ•´
@Column()
@IsEnum(Status)
status: Status;

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„æšä¸¾é…ç½®
@Column({
  type: "enum",
  enum: Status,
  default: Status.ACTIVE,
})
@IsEnum(Status)
status: Status;
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### Entity åˆ›å»ºæ£€æŸ¥æ¸…å•
- [ ] ç»§æ‰¿ BaseEntity
- [ ] ä½¿ç”¨æ­£ç¡®çš„ @Entity è£…é¥°å™¨å’Œè¡¨å
- [ ] æ‰€æœ‰å­—æ®µéƒ½æœ‰é€‚å½“çš„ @Column é…ç½®
- [ ] å¿…å¡«å­—æ®µæœ‰éªŒè¯è£…é¥°å™¨
- [ ] å¯é€‰å­—æ®µæœ‰ @IsOptional() è£…é¥°å™¨
- [ ] æ•°å­—å­—æ®µæœ‰ @Type(() => Number) è½¬æ¢
- [ ] æšä¸¾å­—æ®µæœ‰å®Œæ•´çš„é…ç½®
- [ ] å…³è”å…³ç³»æœ‰æ­£ç¡®çš„è£…é¥°å™¨
- [ ] å¤–é”®å­—æ®µå·²å®šä¹‰
- [ ] å­—æ®µæœ‰æ¸…æ™°çš„æ³¨é‡Š
- [ ] é»˜è®¤å€¼è®¾ç½®åˆç†

### éªŒè¯è£…é¥°å™¨æ£€æŸ¥æ¸…å•
- [ ] @IsString() ç”¨äºå­—ç¬¦ä¸²å­—æ®µ
- [ ] @IsNumber() ç”¨äºæ•°å­—å­—æ®µ
- [ ] @IsBoolean() ç”¨äºå¸ƒå°”å­—æ®µ
- [ ] @IsEnum() ç”¨äºæšä¸¾å­—æ®µ
- [ ] @IsArray() ç”¨äºæ•°ç»„å­—æ®µ
- [ ] @IsOptional() ç”¨äºå¯é€‰å­—æ®µ
- [ ] @Type() ç”¨äºç±»å‹è½¬æ¢
- [ ] @Min()/@Max() ç”¨äºæ•°å€¼èŒƒå›´é™åˆ¶
- [ ] @IsISO8601() ç”¨äºæ—¥æœŸå­—æ®µ

### æ•°æ®åº“çº¦æŸæ£€æŸ¥æ¸…å•
- [ ] ä¸»é”®å­—æ®µæ­£ç¡®é…ç½®
- [ ] å¤–é”®å…³ç³»æ­£ç¡®è®¾ç½®
- [ ] ç´¢å¼•é…ç½®åˆç†
- [ ] å”¯ä¸€çº¦æŸæ­£ç¡®åº”ç”¨
- [ ] çº§è”æ“ä½œé…ç½®é€‚å½“
- [ ] è½¯åˆ é™¤æ”¯æŒå¯ç”¨

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ Entity è¿ç§»åˆ°æ–°è§„èŒƒ

1. **æ£€æŸ¥ç»§æ‰¿å…³ç³»**
   ```typescript
   // ç¡®ä¿ç»§æ‰¿ BaseEntity
   export class OldEntity extends BaseEntity {}
   ```

2. **æ·»åŠ ç¼ºå¤±çš„éªŒè¯è£…é¥°å™¨**
   ```typescript
   // ä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ é€‚å½“çš„éªŒè¯
   @Column()
   @IsString()
   name: string;
   ```

3. **ä¿®å¤ç±»å‹è½¬æ¢**
   ```typescript
   // ä¸ºæ•°å­—å­—æ®µæ·»åŠ ç±»å‹è½¬æ¢
   @Column()
   @IsNumber()
   @Type(() => Number)
   count: number;
   ```

4. **å®Œå–„æšä¸¾é…ç½®**
   ```typescript
   // å®Œæ•´çš„æšä¸¾å­—æ®µé…ç½®
   @Column({
     type: "enum",
     enum: Status,
     default: Status.ACTIVE,
   })
   @IsEnum(Status)
   status: Status;
   ```

5. **æ·»åŠ å¤–é”®å­—æ®µ**
   ```typescript
   // ä¸ºå…³è”å…³ç³»æ·»åŠ å¤–é”®å­—æ®µ
   @ManyToOne(() => Parent)
   parent?: Parent;
   
   @Column({ nullable: true })
   @IsString()
   @IsOptional()
   parentId?: string;
   ```

è¿™ä¸ªè§„èŒƒç¡®ä¿äº† Entity çš„ä¸€è‡´æ€§ã€ç±»å‹å®‰å…¨å’Œæ•°æ®å®Œæ•´æ€§ï¼Œä¸ºæ•´ä¸ªé¡¹ç›®æä¾›äº†åšå®çš„æ•°æ®æ¨¡å‹åŸºç¡€ã€‚
