---
trigger: model_decision
description: AI 筛选流转结构（系统全链路）
globs:
---
# 筛选流转结构（Monorepo 全链路）

以下是系统筛选功能在整个技术栈中的完整流转结构，用于指导筛选相关的设计、实现和优化。从用户输入到数据查询的完整链路，确保筛选功能在所有层级保持一致性和高性能。

## 🎯 适用场景
- **筛选功能设计**：新筛选条件的架构设计和实现路径
- **性能优化评估**：筛选查询的性能分析和索引策略
- **用户体验优化**：筛选交互的流畅性和响应性
- **架构对齐**：确保筛选逻辑在各层级保持一致

**注意**：本文档聚焦于筛选功能的流转结构和性能优化，基础字段操作请使用 `ai-todo-add-field.mdc`。

## 🔍 筛选架构层级与文件路径

### 筛选流转链路
```
用户输入 → 前端筛选 → API调用 → 参数绑定 → DTO验证 → 业务处理 → 查询构建 → 数据库查询 → 结果返回
    ↓         ↓         ↓         ↓         ↓         ↓         ↓         ↓         ↓
   UI     组件状态   网络请求   Controller  验证规则   Service   Repository   SQL    数据
```

### 各层级筛选职责与路径
- **数据库层**：索引优化，查询性能，执行计划
  - 位置：MySQL 数据库表结构与索引

- **仓储层**：查询构建，条件拼装，SQL生成
  - 路径：`packages/business/server/src/{domain}/{module}/*.repository.ts`

- **服务层**：筛选逻辑，参数验证，业务规则
  - 路径：`packages/business/server/src/{domain}/{module}/*.service.ts`

- **DTO层**：筛选参数定义，操作符支持，类型转换
  - 路径：`packages/business/server/src/{domain}/{module}/dto/`

- **控制器层**：参数绑定，请求路由，响应处理
  - 路径：`apps/server/src/business/{domain}/{module}/*.controller.ts`

- **API类型层**：筛选接口定义，类型约束，文档同步
  - 路径：`packages/business/api/controller/{domain}/{module}/`

- **前端组件层**：筛选UI，交互逻辑，状态管理
  - 路径：`packages/business/web/src/pages/{domain}/{module}/`

- **用户体验层**：响应速度，操作便捷，视觉反馈
  - 路径：`packages/business/web/src/components/`（通用筛选组件）

## 🔄 筛选功能实施清单

### 后端筛选实施步骤

#### 1) 实体层 - 筛选字段定义
- [ ] 在 `packages/business/server/src/{domain}/{module}/entities/*.entity.ts` 中定义筛选字段
- [ ] 评估是否需要添加数据库索引
- [ ] 如为枚举字段，引用 `packages/business/enum/{domain}/` 中的枚举

#### 2) DTO层 - 筛选参数定义
- [ ] 在 `packages/business/server/src/{domain}/{module}/dto/` 中创建或更新 FilterDto
- [ ] 定义筛选操作符：eq、ne、gt、lt、gte、lte、like、in、between 等
- [ ] 添加验证装饰器，防止SQL注入
- [ ] 包含分页参数：pageSize、current、sortField、sortOrder

#### 3) 仓储层 - 查询构建
- [ ] **接口定义**：在 `packages/business/server/src/{domain}/{module}/*.repository.ts` 中定义筛选查询接口
- [ ] **参数化查询**：使用参数化查询构建 where 条件，防止SQL注入
- [ ] **组合筛选**：支持 AND/OR 逻辑的复杂查询条件
- [ ] **动态排序**：实现动态排序和分页功能

##### Server环境适配
- [ ] 在 `apps/server/src/business/{domain}/{module}/` 中注入具体的仓储实现
- [ ] 使用 TypeORM 的 QueryBuilder 构建复杂查询
- [ ] 配置数据库连接池和查询缓存
- [ ] 处理数据库事务和并发控制

##### Desktop环境适配
- [ ] 在 `apps/desktop/src/database/{domain}/{module}/` 中实现SQLite查询
- [ ] 使用 better-sqlite3 的 prepared statements
- [ ] 优化本地数据库的查询性能
- [ ] 处理桌面端的数据同步和缓存

#### 4) 服务层 - 业务处理
- [ ] **接口定义**：在 `packages/business/server/src/{domain}/{module}/*.service.ts` 中定义筛选服务接口
- [ ] **参数解析**：解析 FilterDto 参数，构建查询条件
- [ ] **安全检查**：添加业务规则验证和SQL注入防护
- [ ] **特殊处理**：处理空值和特殊值的筛选逻辑

##### Server环境适配
- [ ] 在 `apps/server/src/business/{domain}/{module}/` 中注入服务实现
- [ ] 集成外部服务（如缓存、搜索服务）
- [ ] 处理HTTP请求的筛选参数转换
- [ ] 实现服务间的调用和数据聚合

##### Desktop环境适配
- [ ] 在 `apps/desktop/src/database/{domain}/{module}/` 中实现本地筛选服务
- [ ] 适配 Electron 的 IPC 通信模式
- [ ] 处理本地数据缓存和状态管理
- [ ] 实现离线筛选和数据同步逻辑

#### 5) 控制器层/IPC层 - 接口适配

##### Server环境 - HTTP接口适配
- [ ] 在 `apps/server/src/business/{domain}/{module}/*.controller.ts` 中添加筛选接口
- [ ] 使用 `@Query()` 装饰器绑定筛选参数
- [ ] 实现参数验证管道和DTO转换
- [ ] 返回统一的 PageResponseDto 或 ListResponseDto

##### Desktop环境 - IPC接口适配
- [ ] 在 `apps/desktop/src/main/ipc-handlers.ts` 中添加筛选相关的IPC处理器
- [ ] 实现 `ipcMain.handle('filter-{module}')` 方法
- [ ] 处理前端渲染进程的筛选请求
- [ ] 返回标准化的筛选结果格式

#### 6) API类型层 - 类型同步
- [ ] 在 `packages/business/api/controller/{domain}/{module}/` 中定义筛选接口类型
- [ ] 同步 FilterDto 和响应类型
- [ ] 确保前后端类型定义一致

#### 7) 数据库层 - 索引优化
- [ ] 分析筛选字段的查询频率和选择性
- [ ] 设计合适的索引策略
- [ ] 执行索引创建和性能测试

### 前端筛选实施步骤

#### 1) 类型定义同步
- [ ] 检查 `packages/business/web/src/` 中的类型定义文件
- [ ] 同步后端 FilterDto 和响应类型的变更

#### 2) 筛选组件开发
- [ ] 在 `packages/business/web/src/pages/{domain}/{module}/` 中创建筛选表单
- [ ] 实现各种筛选控件：输入框、下拉选择、日期选择器等
- [ ] 支持组合筛选和条件重置

#### 3) 状态管理集成
- [ ] 更新相关 store 或 hooks 管理筛选状态
- [ ] 实现筛选条件的持久化和恢复
- [ ] 处理加载状态和错误状态

#### 4) API调用集成
- [ ] 实现筛选参数的序列化
- [ ] 处理分页和排序参数
- [ ] 优化请求频率（防抖、缓存等）

### 筛选操作符支持检查
- [ ] **基本操作符**：等于(eq)、不等于(ne)、包含(in)、不包含(notIn)
- [ ] **范围操作符**：大于(gt)、小于(lt)、大于等于(gte)、小于等于(lte)、区间(between)
- [ ] **字符串操作符**：模糊匹配(like)、前缀匹配(startsWith)、后缀匹配(endsWith)
- [ ] **空值操作符**：为空(isNull)、不为空(isNotNull)
- [ ] **组合逻辑**：与(and)、或(or)、非(not)

## ✅ 筛选功能验证清单

### 功能完整性验证
- [ ] 所有支持的筛选操作符工作正常
- [ ] 组合筛选逻辑正确（AND/OR关系）
- [ ] 空值和特殊值的处理符合预期
- [ ] 分页和排序功能与筛选兼容

### 性能验证
- [ ] 筛选查询响应时间满足性能要求
- [ ] 数据库索引得到有效利用
- [ ] 大数据量下的筛选性能稳定
- [ ] 内存和CPU使用率在合理范围内

### 用户体验验证
- [ ] 筛选UI响应及时，反馈明确
- [ ] 筛选条件重置功能简单易用
- [ ] 加载状态和错误处理用户友好
- [ ] 移动端适配良好

## 📋 筛选使用指南

### 场景适配
1. **新筛选功能设计**：使用完整流转检查清单进行架构设计
2. **现有筛选优化**：重点关注性能层级验证
3. **用户体验改进**：从用户体验层开始优化
4. **性能问题排查**：按层级逐一排查性能瓶颈

### 实施策略
- **性能优先**：筛选功能必须考虑数据库索引和查询优化
- **安全第一**：始终使用参数化查询，防止SQL注入
- **用户中心**：筛选UI要简单直观，响应快速
- **监控到位**：建立筛选查询的性能监控机制

## 🛡️ 筛选关键原则

### 性能优化原则
- **索引策略**：根据筛选频率和选择性设计索引
- **查询优化**：使用覆盖索引，避免全表扫描
- **缓存机制**：对常用筛选结果进行缓存
- **分页优化**：合理设置分页大小，避免大数据量查询

### 安全防护原则
- **参数验证**：严格验证所有筛选参数的类型和范围
- **注入防护**：使用参数化查询，防止SQL注入攻击
- **权限控制**：确保用户只能筛选其有权限访问的数据
- **审计日志**：记录重要的筛选操作用于安全审计

### 用户体验原则
- **响应速度**：筛选结果应在用户可接受的时间内返回
- **操作简便**：提供直观的筛选界面和操作方式
- **反馈明确**：清晰显示筛选状态、结果数量、加载进度
- **容错性好**：对用户的错误操作有友好的提示和处理

### 架构一致性原则
- **类型同步**：前后端筛选参数类型定义保持一致
- **操作符统一**：筛选操作符在各层级保持相同的语义
- **错误处理**：统一的错误处理和用户提示机制
- **文档同步**：API文档与实现保持同步更新

## 🏛️ 筛选架构模式说明

### 跨环境筛选实现
- **packages/business/server**：定义筛选接口和基础逻辑
- **apps/server**：MySQL环境的具体筛选实现，复杂查询优化
- **apps/desktop**：SQLite环境的筛选实现，本地查询优化
- **packages/business/api**：筛选参数和结果的类型定义

### 筛选性能优化策略
- **索引设计**：根据筛选频率和选择性设计复合索引
- **查询缓存**：对常用筛选条件的结果进行缓存
- **分页优化**：使用游标分页避免深度分页性能问题
- **异步处理**：复杂筛选采用异步处理，提升用户体验

### 安全筛选机制
- **参数验证**：严格验证筛选参数的类型、范围和格式
- **SQL注入防护**：使用参数化查询和预编译语句
- **权限筛选**：在查询层面实现数据权限过滤
- **审计日志**：记录重要的筛选操作和结果统计